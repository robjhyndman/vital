---
title: "Stochastic population forecasting"
author: Rob J Hyndman
bibliography: refs.bib
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Stochastic population forecasting}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(vital)
library(dplyr)
```

The vital package can be used for stochastic population forecasting with coherent components. This is based on the papers by @HB08 and @hby. Following @HB08, we use the following demographic growth-balance equations:
$$
P_t(x) = P_{t-1}(x) + B_t(x) - D_t(x) + N_t(x) 
$$
where

* $P_t(x)$ is the population at time $t$ and age $x$,
* $B_t(x)$ is the number of births at time $t$ and age $x$,
* $D_t(x)$ is the number of deaths at time $t$ and age $x$, and
* $N_t(x)$ is the number of net migrants at time $t$ and age $x$.

To simulate future births, deaths and net migrants, we develop three functional data models for fertility, mortality and migration. The models for mortality and migration use coherent components [@hby], so that the rates for males and females do not diverge over time. 

The following example uses Norwegian data up to 2022, and simulates ten future years. 

## Migration model

```{r}
fit_mortality <- norway_mortality |> 
  filter(Sex != "Total") |>
  smooth_mortality(Mortality) |>
  model(fdm = FDM(log(.smooth), coherent = TRUE))
future_mortality <- fit_mortality |>
  generate(h = 10, times = 1000) |>
  rename(mx = .sim) |>
  select(-.model)
```

## Fertility model

```{r}
fit_fertility <- norway_fertility |>
  smooth_fertility(Fertility) |>
  model(fdm = FDM(log(.smooth)))
future_fertility <- fit_fertility |>
  generate(h = 10, times = 1000) |>
  rename(fx = .sim) |>
  select(-.model)
```

## Net migration model

```{r}
netmig <- net_migration(
  norway_mortality |> filter(Sex != "Total"), 
  norway_births
) |>
  mutate(rate = NetMigration / Population) 
fit_migration <- netmig |>
  model(fdm = FDM(rate, coherent = TRUE))
future_migration <- fit_migration |>
  generate(h = 10, times = 1000) |>
  rename(nx = .sim) |>
  select(-.model)
```

# Population simulation

```{r}
pop <- norway_mortality |> 
  filter(Sex != "Total", Year == max(Year)) |>
  mutate(Year = Year + 1, Prev_Pop = Population)  |>
  select(Year, Age, Sex, Prev_Pop)
future <- as_tibble(pop) |>
  right_join(as_tibble(future_mortality)) |>
  left_join(as_tibble(future_fertility) |> mutate(Sex = "Female")) |>
  left_join(future_migration) |>
  mutate(fx = tidyr::replace_na(fx, 0))
yrs <- sort(unique(future$Year))
for(y in yrs) {
  cut <- future[future$Year == y,]
  births <- cut |>
    group_by(.rep) |> 
    summarise(
      Births = sum(fx * Prev_Pop, na.rm = TRUE),
      .groups = "drop"
    )
  
  cut$Population <- cut$Prev_Pop + 
    cut$fx * cut$Population - 
    cut$mx * cut$Population + 
    cut$nx * cut$Population
}
```
  
